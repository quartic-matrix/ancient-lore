<html>
  <body>

    <div id="players">
      <h1>Players</h1>
      <div id="player-list">
      </div>
    </div>


    <script src="deploy/webrtc-swarm.js"></script> 
    <script src="scripts/events.js"></script> 
    <script src="scripts/game-system.js"></script> 
    <script src="scripts/ancient-lore.js"></script> 
    <script>
      var game;
      var gameDisplay;

      document.addEventListener("onload",init(),false);

      function makeSwarm() {
        var swarm;
        if (true) {
          swarm = new WebRTCSwarm('swarm-example', ['https://quartic-matrix-signalhub.herokuapp.com/'])
          var isMyFirstConnection = true;

          if (!swarm.WEBRTC_SUPPORT) {

          }

          swarm.on('connect', function (peer, id) {
            console.log('connected to a new peer:', id);
            console.log('total peers:', swarm.peers.length);

            peer.on('error', function (err) { 
              console.log('error', err); 
            })
            
            peer.on('data', function (json) {
              var data = JSON.parse(json);
              game.onReceive(data);
            });

            game.onConnect(peer, id);

            // if (isMyFirstConnection) {
            //   isMyFirstConnection = false;
            //   var json = JSON.stringify(fullUpdateData());
            //   peer.send(json);
            // }
          })

          swarm.on('disconnect', function (peer, id) {
            console.log('disconnected from a peer:', id)
            console.log('total peers:', swarm.peers.length)
          })
        } else {
          swarm = {};
          swarm.me = -1;
          swarm.peers = [];
        }
        return swarm;
      }

      function init() {
        var url = new URL(window.location.href);
        var playerName = url.searchParams.get("player");
        if (!playerName) {
          playerName = "<player-name>";
        }

        let colours = generateHslaColors(70, 50, 1.0, 6);

        game = new AncientLoreGame(makeSwarm(), playerName);

        gameDisplay = new AncientLoreDisplayUpdater(
          new AncientLoreDisplay("player-list"), game.eventLog
        );
      }

      function generateHslaColors (saturation, lightness, alpha, amount) {
        let colors = []
        let huedelta = Math.trunc(360 / amount)

        for (let i = 0; i < amount; i++) {
          let hue = i * huedelta
          colors.push(`hsla(${hue},${saturation}%,${lightness}%,${alpha})`)
        }

        return colors
      }

      function formatTime(timeInMs) {
        var milliseconds = parseInt((timeInMs % 1000) / 100);
        var seconds = Math.floor((timeInMs / 1000) % 60);
        var minutes = Math.floor((timeInMs / (1000 * 60)) % 60);
        var hours = Math.floor((timeInMs / (1000 * 60 * 60)) % 24);

        return hours + ":" + makeTwoDigits(minutes) + ":" + makeTwoDigits(seconds) + "." + milliseconds;
      }

      function makeTwoDigits(number) {
        return ("0" + number).slice(-2);
      }
    </script> 
  </body>
</html>
